MODx.panel.Resource=function(B){B=B||{record:{}};B.record=B.record||{};var D={title:_("resource_content"),id:"modx-resource-content",layout:"form",bodyStyle:"padding: 15px;",autoHeight:true,collapsible:false,items:[{id:"modx-content-above",border:false},{xtype:"textarea",name:"ta",id:"ta",hideLabel:true,anchor:"97%",height:400,grow:false,value:(B.record.content||B.record.ta)||""},{id:"modx-content-below",border:false}]};delete rte;var E=[];E.push({title:_("createedit_document"),id:"modx-resource-settings",cls:"modx-resource-tab",layout:"form",labelWidth:200,bodyStyle:"padding: 15px 15px 15px 0;",autoHeight:true,defaults:{border:false,msgTarget:"side",width:400},items:[{xtype:(B.resource?"statictextfield":"hidden"),fieldLabel:_("id"),description:"<b>[[*id]]</b><br />",name:"id",id:"modx-resource-id",anchor:"97%",value:B.resource||B.record.id,submitValue:true},{layout:"column",border:false,anchor:"97%",items:[{columnWidth:0.7,layout:"form",border:false,items:[{xtype:"modx-combo-template",fieldLabel:_("resource_template"),description:"<b>[[*template]]</b><br />"+_("resource_template_help"),name:"template",id:"modx-resource-template",anchor:"97%",editable:false,baseParams:{action:"getList",combo:"1"},listeners:{select:{fn:this.templateWarning,scope:this}}}]},{columnWidth:0.3,layout:"form",hideLabels:true,labelWidth:0,border:false,items:[{xtype:"checkbox",boxLabel:_("resource_published"),description:"<b>[[*published]]</b><br />"+_("resource_published_help"),name:"published",id:"modx-resource-published",inputValue:1,checked:B.record.published}]}]},{xtype:"textfield",fieldLabel:_("resource_pagetitle"),description:"<b>[[*pagetitle]]</b><br />"+_("resource_pagetitle_help"),name:"pagetitle",id:"modx-resource-pagetitle",maxLength:255,anchor:"75%",allowBlank:false,enableKeyEvents:true,listeners:{keyup:{scope:this,fn:function(G,H){Ext.getCmp("modx-resource-header").getEl().update("<h2>"+_("document")+": "+G.getValue()+"</h2>");}}}},{xtype:"textfield",fieldLabel:_("resource_longtitle"),description:"<b>[[*longtitle]]</b><br />"+_("resource_longtitle_help"),name:"longtitle",id:"modx-resource-longtitle",maxLength:255,anchor:"75%",value:B.record.longtitle||""},{xtype:"textfield",fieldLabel:_("resource_description"),description:"<b>[[*description]]</b><br />"+_("resource_description_help"),name:"description",id:"modx-resource-description",maxLength:255,anchor:"75%",value:B.record.description||""},{xtype:"textfield",fieldLabel:_("resource_alias"),description:"<b>[[*alias]]</b><br />"+_("resource_alias_help"),name:"alias",id:"modx-resource-alias",maxLength:100,anchor:"75%",value:B.record.alias||""},{xtype:"textfield",fieldLabel:_("resource_link_attributes"),description:"<b>[[*link_attributes]]</b><br />"+_("resource_link_attributes_help"),name:"link_attributes",id:"modx-resource-link-attributes",maxLength:255,anchor:"75%",value:B.record.link_attributes||""},{xtype:"textarea",fieldLabel:_("resource_summary"),description:"<b>[[*introtext]]</b><br />"+_("resource_summary_help"),name:"introtext",id:"modx-resource-introtext",grow:true,anchor:"90%",value:B.record.introtext||""},{xtype:"modx-field-parent-change",fieldLabel:_("resource_parent"),description:"<b>[[*parent]]</b><br />"+_("resource_parent_help"),name:"parent-cmb",id:"modx-resource-parent",value:B.record.parent||0,anchor:"70%"},{xtype:"hidden",name:"parent",value:B.record.parent||0,id:"modx-resource-parent-hidden"},{xtype:"textfield",fieldLabel:_("resource_menutitle"),description:"<b>[[*menutitle]]</b><br />"+_("resource_menutitle_help"),name:"menutitle",id:"modx-resource-menutitle",maxLength:255,anchor:"70%",value:B.record.menutitle||""},{xtype:"numberfield",fieldLabel:_("resource_menuindex"),description:"<b>[[*menuindex]]</b><br />"+_("resource_menuindex_help"),name:"menuindex",id:"modx-resource-menuindex",width:60,value:B.record.menuindex||0},{xtype:"checkbox",fieldLabel:_("resource_hide_from_menus"),description:"<b>[[*hidemenu]]</b><br />"+_("resource_hide_from_menus_help"),name:"hidemenu",id:"modx-resource-hidemenu",inputValue:1,checked:false,value:B.record.hidemenu||0},{xtype:"hidden",name:"type",value:"document"},{xtype:"hidden",name:"context_key",id:"modx-resource-context-key",value:B.record.context_key||"web"},{xtype:"hidden",name:"content",id:"hiddenContent",value:(B.record.content||B.record.ta)||""},{html:MODx.onDocFormRender,border:false}]});if(!MODx.config.manager_use_tabs){E.push(D);}var F=[];F.push({xtype:"checkbox",fieldLabel:_("resource_folder"),description:"<b>[[*isfolder]]</b><br />"+_("resource_folder_help"),name:"isfolder",id:"modx-resource-isfolder",inputValue:1,checked:B.record.isfolder||0},{xtype:"checkbox",fieldLabel:_("resource_richtext"),description:"<b>[[*richtext]]</b><br />"+_("resource_richtext_help"),name:"richtext",id:"modx-resource-richtext",inputValue:1,checked:B.record.richtext},{xtype:"xdatetime",fieldLabel:_("resource_publishedon"),description:"<b>[[*publishedon]]</b><br />"+_("resource_publishedon_help"),name:"publishedon",id:"modx-resource-publishedon",allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,dateWidth:120,timeWidth:120,value:B.record.publishedon});if(MODx.config.publish_document){F.push({xtype:"xdatetime",fieldLabel:_("resource_publishdate"),description:"<b>[[*pub_date]]</b><br />"+_("resource_publishdate_help"),name:"pub_date",id:"modx-resource-pub-date",allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,dateWidth:120,timeWidth:120,value:B.record.pub_date});}if(MODx.config.publish_document){F.push({xtype:"xdatetime",fieldLabel:_("resource_unpublishdate"),description:"<b>[[*unpub_date]]</b><br />"+_("resource_unpublishdate_help"),name:"unpub_date",id:"modx-resource-unpub-date",allowBlank:true,dateFormat:MODx.config.manager_date_format,timeFormat:MODx.config.manager_time_format,dateWidth:120,timeWidth:120,value:B.record.unpub_date});}F.push({xtype:"checkbox",fieldLabel:_("resource_searchable"),description:"<b>[[*searchable]]</b><br />"+_("resource_searchable_help"),name:"searchable",id:"modx-resource-searchable",inputValue:1,checked:B.record.searchable},{xtype:"checkbox",fieldLabel:_("resource_cacheable"),description:"<b>[[*cacheable]]</b><br />"+_("resource_cacheable_help"),name:"cacheable",id:"modx-resource-cacheable",inputValue:1,checked:B.record.cacheable},{xtype:"checkbox",fieldLabel:_("resource_syncsite"),description:_("resource_syncsite_help"),name:"syncsite",id:"modx-resource-syncsite",inputValue:1,checked:true,value:B.record.syncsite||1},{xtype:"checkbox",fieldLabel:_("deleted"),description:"<b>[[*deleted]]</b>",name:"deleted",id:"modx-resource-deleted",inputValue:1,checked:false,value:B.record.deleted||0},{xtype:"modx-combo-content-type",fieldLabel:_("resource_content_type"),description:"<b>[[*content_type]]</b><br />"+_("resource_content_type_help"),name:"content_type",hiddenName:"content_type",id:"modx-resource-content-type",anchor:"70%",value:B.record.content_type||1},{xtype:"modx-combo-content-disposition",fieldLabel:_("resource_contentdispo"),description:"<b>[[*content_dispo]]</b><br />"+_("resource_contentdispo_help"),name:"content_dispo",hiddenName:"content_dispo",id:"modx-resource-content-dispo",anchor:"70%",value:B.record.content_dispo||0},{xtype:"modx-combo-class-map",fieldLabel:_("class_key"),description:"<b>[[*class_key]]</b><br />",name:"class_key",hiddenName:"class_key",id:"modx-resource-class-key",baseParams:{action:"getList",parentClass:"modResource"},allowBlank:false,value:B.record.class_key||"modDocument",anchor:"70%"});E.push({id:"modx-page-settings",title:_("page_settings"),cls:"modx-resource-tab",layout:"form",forceLayout:true,deferredRender:false,labelWidth:200,bodyStyle:"padding: 15px 15px 15px 0;",autoHeight:true,defaults:{border:false,msgTarget:"side"},items:F});E.push({xtype:"modx-panel-resource-tv",collapsed:false,resource:B.resource,class_key:B.record.class_key||"modDocument",template:B.record.template,anchor:"100%"});if(B.access_permissions){E.push({id:"modx-resource-access-permissions",bodyStyle:"padding: 15px;",autoHeight:true,title:_("access_permissions"),layout:"form",anchor:"100%",items:[{html:"<p>"+_("resource_access_message")+"</p>",border:false},{xtype:"modx-grid-resource-security",preventRender:true,resource:B.resource,listeners:{afteredit:{fn:this.fieldChangeEvent,scope:this}}}]});}var C=[];C.push({html:"<h2>"+_("document_new")+"</h2>",id:"modx-resource-header",cls:"modx-page-header",border:false,forceLayout:true,anchor:"100%"});C.push(MODx.getPageStructure(E,{id:"modx-resource-tabs",forceLayout:true,deferredRender:false,collapsible:true}));if(MODx.config.manager_use_tabs){D.style="margin-top: 10px;";C.push(D);}Ext.applyIf(B,{url:MODx.config.connectors_url+"resource/index.php",baseParams:{},id:"modx-panel-resource",class_key:"modResource",resource:"",bodyStyle:"",defaults:{collapsible:false,autoHeight:true},forceLayout:true,items:C,fileUpload:true,useLoadingMask:true,listeners:{setup:{fn:this.setup,scope:this},success:{fn:this.success,scope:this},beforeSubmit:{fn:this.beforeSubmit,scope:this}}});MODx.panel.Resource.superclass.constructor.call(this,B);var A=Ext.get("ta");if(A){A.on("keydown",this.fieldChangeEvent,this);}this.on("ready",this.onReady,this);};Ext.extend(MODx.panel.Resource,MODx.FormPanel,{rteLoaded:false,initialized:false,defaultClassKey:"modResource",setup:function(){if(!this.initialized){this.getForm().setValues(this.config.record);if(Ext.isEmpty(this.config.record.parent_pagetitle)){this.getForm().findField("parent-cmb").setValue("");}else{this.getForm().findField("parent-cmb").setValue(this.config.record.parent_pagetitle+" ("+this.config.record.parent+")");}if(!Ext.isEmpty(this.config.record.pagetitle)){Ext.getCmp("modx-resource-header").getEl().update("<h2>"+_("document")+": "+this.config.record.pagetitle+"</h2>");}this.defaultClassKey=this.config.record.class_key||"modDocument";}if(MODx.config.use_editor&&MODx.loadRTE){var A=this.getForm().findField("richtext");if(A&&A.getValue()==1&&!this.rteLoaded){MODx.on("ready",function(){MODx.loadRTE("ta");});this.rteLoaded=true;}else{if(A&&A.getValue()==0&&this.rteLoaded){if(MODx.unloadRTE){MODx.unloadRTE("ta");}this.rteLoaded=false;}}}this.fireEvent("ready");this.initialized=true;},beforeSubmit:function(E){var B=Ext.get("ta");if(!B){return false;}var A=B.dom.value;var D=Ext.getCmp("hiddenContent");if(D){D.setValue(A);}var C=Ext.getCmp("modx-grid-resource-security");if(C){Ext.apply(E.form.baseParams,{resource_groups:C.encodeModified()});}this.cleanupEditor();return this.fireEvent("save",{values:this.getForm().getValues(),stay:Ext.state.Manager.get("modx.stay."+MODx.request.a,"stay")});},success:function(F){var E=Ext.getCmp("modx-grid-resource-security");if(E){E.getStore().commitChanges();}var C=Ext.getCmp("modx-resource-tree");if(C){var A=Ext.getCmp("modx-resource-context-key").getValue();var D=Ext.getCmp("modx-resource-parent-hidden").getValue();var B=A+"_"+D;var G=C.getNodeById(B);G.leaf=false;C.refreshNode(B,true);}if(F.result.object.class_key!=this.defaultClassKey&&this.config.resource!=""&&this.config.resource!=0){location.href=location.href;}else{this.getForm().setValues(F.result.object);Ext.getCmp("modx-page-update-resource").config.preview_url=F.result.object.preview_url;}},templateWarning:function(){var A=Ext.getCmp("modx-resource-template");if(!A){return false;}if(A.getValue()!==A.originalValue){Ext.Msg.confirm(_("warning"),_("resource_change_template_confirm"),function(C){if(C=="yes"){if(MODx.unloadTVRTE){MODx.unloadTVRTE();}var B=Ext.getCmp("modx-panel-resource-tv");if(B&&B.body){this.tvum=B.body.getUpdater();this.tvum.update({url:"index.php?a="+MODx.action["resource/tvs"],params:{class_key:this.config.record.class_key,resource:(this.config.resource?this.config.resource:0),template:A.getValue()},discardUrl:true,scripts:true,nocache:true,callback:function(D){B.fireEvent("load");},scope:this});}A.originalValue=A.getValue();}else{A.setValue(this.config.record.template);}},this);}},changeEditor:function(){this.cleanupEditor();this.on("success",function(C){var D=C.result.object.id;var A=Ext.getCmp("modx-resource-which-editor").getValue();MODx.request.a=MODx.action["resource/update"];var B="?"+Ext.urlEncode(MODx.request)+"&which_editor="+A+"&id="+D;location.href=B;});this.submit();},cleanupEditor:function(){if(MODx.onSaveEditor){var A=Ext.getCmp("ta");if(A){MODx.onSaveEditor(A);}}}});Ext.reg("modx-panel-resource",MODx.panel.Resource);var triggerDirtyField=function(A){Ext.getCmp("modx-panel-resource").fieldChangeEvent(A);};MODx.triggerRTEOnChange=function(){triggerDirtyField(Ext.getCmp("ta"));};MODx.fireResourceFormChange=function(C,A,B){Ext.getCmp("modx-panel-resource").fireEvent("fieldChange");};